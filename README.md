# Telegram Wireguard Bot

Телеграм-бот для управления доступом к WireguardAPI с функциями white list, напоминаний об оплате и массовой рассылки.

## Возможности

1. **White list пользователей** - доступ к боту только для пользователей из конфигурационного файла
2. **Напоминания об оплате** - автоматические уведомления пользователям и админу о днях оплаты
3. **Массовая рассылка** - возможность отправки сообщений всем пользователям (только для админа)
4. **Получение конфигурации Wireguard** - команда `/conf` для скачивания .conf файла
5. **Получение QR-кода** - команда `/qrcode` для получения QR-кода подключения

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd tg-wireguard-bot
```

2. Установите зависимости:
```bash
uv sync
```

3. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

4. Заполните переменные окружения в `.env`:
```env
WIREGUARD_PASSWORD="ваш_пароль_wireguard_api"
WIREGUARD_BASE_URL="https://your-wireguard-server.com"
TELEGRAM_BOT_TOKEN="ваш_токен_телеграм_бота"
ADMIN_TELEGRAM_ID="ваш_telegram_id"
```

## Конфигурация пользователей

Конфигурация пользователей загружается через CSV файл с следующими столбцами:

- `telegram_id` - тег пользователя в формате @username
- `wireguard_id` - ID профиля пользователя в Wireguard
- `expire_day` - дата оплаты в формате cron

### Пример CSV файла:

```csv
telegram_id,wireguard_id,expire_day
@user1,8d5564c0-b985-495c-955d-e80532cac603,0 0 1 * *
@user2,f2a3b4c5-d6e7-f8g9-h0i1-j2k3l4m5n6o7,0 0 15 * *
@admin,a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6,0 0 5 * *
```

### Формат cron для дат оплаты:

- `0 0 1 * *` - 1 число каждого месяца в 00:00
- `0 0 15 * *` - 15 число каждого месяца в 00:00
- `0 0 * * 1` - каждый понедельник в 00:00

## Запуск

```bash
python main.py
```

## Команды бота

### Для всех пользователей:

- `/start` - приветственное сообщение и список команд
- `/conf` - получить конфигурационный файл Wireguard (.conf)
- `/qrcode` - получить QR-код для подключения (SVG файл)

### Для администратора:

- `/broadcast <сообщение>` - отправить сообщение всем пользователям
- `/config` - показать текущую конфигурацию пользователей
- Загрузка CSV файла - обновление конфигурации пользователей

## Функции

### White List

Бот проверяет каждого пользователя по списку в CSV файле. Доступ разрешен только пользователям, чьи telegram_id присутствуют в конфигурации.

### Напоминания об оплате

Бот автоматически проверяет даты оплаты каждый час и отправляет:
- Напоминание пользователю о необходимости оплаты
- Уведомление админу о том, что у пользователя день оплаты

### Массовая рассылка

Администратор может отправить сообщение всем пользователям из white list:
```
/broadcast Важное уведомление для всех пользователей
```

### Получение конфигурации

Пользователи могут получить свой конфигурационный файл Wireguard:
```
/conf
```
Бот отправит файл `wireguard_username.conf`

### Получение QR-кода

Пользователи могут получить QR-код для быстрого подключения:
```
/qrcode
```
Бот отправит SVG файл с QR-кодом

## Структура проекта

```
tg-wireguard-bot/
├── bot/
│   ├── __init__.py
│   └── telegram_bot.py      # Основной код телеграм-бота
├── wireguard/
│   ├── __init__.py
│   └── wireguard.py         # API для работы с Wireguard
├── main.py                  # Точка входа
├── .env.example            # Пример переменных окружения
├── users_example.csv       # Пример CSV файла с пользователями
├── pyproject.toml          # Конфигурация проекта
└── README.md               # Документация
```

## Безопасность

- Все команды администратора проверяются по ADMIN_TELEGRAM_ID
- Доступ к боту ограничен white list из CSV файла
- Логирование всех операций для мониторинга
- Валидация cron выражений при загрузке конфигурации

## Логирование

Бот ведет подробные логи всех операций:
- Успешные и неуспешные попытки доступа
- Ошибки при работе с Wireguard API
- Отправка напоминаний об оплате
- Массовые рассылки

## Требования

- Python 3.12+
- Доступ к Wireguard API
- Токен Telegram бота
- CSV файл с конфигурацией пользователей
